{% extends "base.html" %}

{% block title %}Configurações - Sistema Anti-Mofo{% endblock %}

{% block content %}
<h1>Configurações do Sistema</h1>
<p>Gerencie as configurações do sistema anti-mofo e controle de LED.</p>

<div class="scene-configuration">
  <h2>Configurar Temperatura para Cenas</h2>
  <form id="sceneForm">
    <label for="minTemperature">Temperatura Mínima (°C):</label>
    <input
      type="number"
      id="minTemperature"
      name="minTemperature"
      value="22"
      required
    />

    <label for="maxTemperature">Temperatura Máxima (°C):</label>
    <input
      type="number"
      id="maxTemperature"
      name="maxTemperature"
      value="27"
      required
    />

    <button type="submit">Salvar Configurações</button>
  </form>

  <!-- Botão para desabilitar ou habilitar a lógica -->
  <div style="margin-top: 20px;">
    <button id="toggleLogicButton">Desabilitar Lógica</button>
    <span id="loadingIndicator" style="display:none;">Carregando...</span>
  </div>
</div>

<script>
  // Função para exibir/ocultar o indicador de carregamento
  function toggleLoading(show) {
    const loadingIndicator = document.getElementById("loadingIndicator");
    loadingIndicator.style.display = show ? "inline" : "none";
  }

  // Função para enviar configurações de temperatura mínima e máxima para o backend
  document.getElementById("sceneForm").addEventListener("submit", async function (event) {
    event.preventDefault();

    const minTemp = document.getElementById("minTemperature").value;
    const maxTemp = document.getElementById("maxTemperature").value;

    try {
      toggleLoading(true);

      const response = await fetch("/api/configuracao", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ minTemperature: minTemp, maxTemperature: maxTemp }),
      });

      const result = await response.json();
      alert(result.message);
    } catch (error) {
      alert("Erro ao salvar configurações!");
    } finally {
      toggleLoading(false);
    }
  });

  // Função para alternar o estado da lógica (habilitar/desabilitar)
  async function toggleLogic() {
    const button = document.getElementById("toggleLogicButton");

    try {
      toggleLoading(true);

      // Desabilita temporariamente o botão para evitar múltiplos cliques
      button.disabled = true;

      const response = await fetch("/api/toggle-logic", {
        method: "POST",
      });

      const result = await response.json();

      // Atualiza o texto do botão com base no novo estado
      button.textContent = result.disable_logic ? "Habilitar Lógica" : "Desabilitar Lógica";
      alert(result.message);
    } catch (error) {
      alert("Erro ao alternar a lógica de cena!");
    } finally {
      button.disabled = false; // Habilita o botão novamente
      toggleLoading(false);
    }
  }

  // Adicionar evento de clique no botão de alternância
  document.getElementById("toggleLogicButton").addEventListener("click", toggleLogic);

  // Função para atualizar o estado do botão ao carregar a página
  async function updateButtonState() {
    try {
      toggleLoading(true);

      const response = await fetch("/api/get-logic-state");
      const result = await response.json();

      const button = document.getElementById("toggleLogicButton");
      button.textContent = result.disable_logic ? "Habilitar Lógica" : "Desabilitar Lógica";
    } catch (error) {
      alert("Erro ao obter o estado atual da lógica!");
    } finally {
      toggleLoading(false);
    }
  }

  // Atualizar o botão inicialmente com base no estado atual
  window.addEventListener("load", updateButtonState);
</script>
{% endblock %}